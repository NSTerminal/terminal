# Building Network Socket Terminal

To build NST from source code, you will need [xmake](https://xmake.io) and an up-to-date compiler (see below).

All commands are run in the repository root.

## Tools

This project uses C++23 features and Swift-to-C++ interop. Required tools and their minimum versions are listed below:

- Clang 18 (Clang 19 is required on Windows which fixes false positive ODR violation errors from the Microsoft STL)
- Swift 5.9 (Swift is only used on macOS)
- Python 3.10

All code is standards compliant. However, because the project uses recent C++ features, other compilers, and versions older than those listed above, are not supported.

## Configuring the Build

The arguments below are passed to `xmake f`/`xmake config` to configure the build process. Configuration should be done before compiling.

**Note:** You should set all of your desired options in one config command. An invocation overwrites previously set configuration options.

When configuring for the first time, xmake will ask you to install libraries needed by NST. Enter `y` to continue and install them.

If you are using the xmake VSCode extension, these arguments can be saved in the `xmake.additionalConfigArguments` setting.

### General

- `--sdk=[PATH]`: Directory containing the C and C++ compilers (only needed if not using the system's default compiler)
- `--cxxflags=...`: C++ compilation flags
- `--ldflags=...`: Linker flags

Platform-specific configuration options:

- **Windows:** Requires linking to `clang_rt.builtins-x86_64.lib`, located at `C:\Program Files\Microsoft Visual Studio\[YEAR]\[EDITION]\VC\Tools\Llvm\x64\lib\clang\[LLVM-VERSION]\lib\windows` (requires LLVM tools to be installed in the Visual Studio installer). The first dot in the file name may cause issues with the linker - to solve this, duplicate the file, rename it, and link to that.
- **Linux:** Requires the libc++ and libc++ experimental libraries (add `-stdlib=libc++` to `cxxflags` and `ldflags`). On some platforms, there may be an "archive has no symbols" error when linking `libc++experimental`; use LLD as the linker (add `-fuse-ld=lld` to `ldflags`) to solve this.

### Build Mode

Use one of the following to set the build mode:

```text
-m debug   # For debug builds (default)
-m release # For release builds
```

### Toolchain

The following LLVM tools are required in addition to the Clang compiler:

- `llvm-ar`
- `llvm-rc` (Windows only)

```text
--toolchain=clang # Use Clang
--ar=llvm-ar      # LLVM archiver
--mrc=llvm-rc     # LLVM resource compiler (Windows only)
```

### Locating Packaged Libraries (Linux)

The package generated by xmake (see below) has the directories `bin` (containing the executable) and `lib` (containing the shared libraries) side-by-side. To locate the libraries at runtime, add the following to `ldflags`. Make sure `$ORIGIN` is escaped in your shell:

```text
-Wl,-rpath,$ORIGIN/../lib
```

## Compiling With xmake

```shell
xmake build swift # Build Swift code (macOS only)
xmake             # Build project
xmake run         # Run app
```

## Packaging

Creating a distributable package for NST is done with `xmake i`/`xmake install`:

```shell
xmake i -o /path/to/package terminal
```

This command must be run after a successful compilation. xmake will copy files such as the built executable and all required shared libraries and download third-party licenses into the specified output directory.
